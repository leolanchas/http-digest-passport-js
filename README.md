http-digest-passport-js
=======================

Implementation of Http digest in javascript via node js

<p>When implementing an API need to protect its endpoints in each request. So you need to authenticate them.</p>
<p>PassportJS is authentication middleware for <a href="http://nodejs.org/">Node.js</a>.It is extremely flexible and modular, and designed to serve a&nbsp; purpoose: authenticate requests. It can be unobtrusively dropped in to any <a href="http://expressjs.com/">Express</a>-based web application.</p>
<p>Passport recognizes that each application has unique authentication requirements. Authentication mechanisms, known as <em>strategies</em>, are packaged as individual modules. Applications can choose which strategies to employ, without creating unnecessary dependencies.</p>
<h3>Basic &amp; Digest</h3>
<p>Along with defining HTTP's authentication framework, <a href="http://tools.ietf.org/html/rfc2617">RFC 2617</a> also defined the Basic and Digest authentications schemes. These two schemes both use usernames and passwords as credentials to authenticate users, and are often used to protect API endpoints.</p>
<p>It should be noted that relying on username and password creditials can have adverse security impacts, especially in scenarios where there is not a high degree of trust between the server and client. In these situations, it is recommended to use an authorization framework such as <a href="http://passportjs.org/guide/oauth2-api/">OAuth 2.0</a>.</p>
<p></p>
<p>In this post I'll explain how to implement the Digest scheme.</p>
<p></p>
<p>I presume <a href="http://nodejs.org/download/" title="Download Node">Node.JS</a> is installed on your system. You also need Express:</p>
<pre><code class="undefinedbash">$ npm install express</code></pre>
<p>and</p>
<p>Passportjs:</p>
<pre><code class="undefinedbash">$ npm install passport</code></pre>
<p>and its basic and digest strategies:</p>
<pre><code class="undefinedbash">$ npm install passport-http</code></pre>
<p>The source is hosted at github: <span class="quote"><a href="https://github.com/leolanchas/http-digest-passport-js" title="Repo Github" target="_blank">https://github.com/leolanchas/http-digest-passport-js</a></span> and you can run it at c9.io:&nbsp; <span class="quote"><a href="https://c9.io/leolanchas/http-digest-passport-js" title="c9.io (https://c9.io/leolanchas/http-digest-passport-js)" target="_blank">https://c9.io/leolanchas/http-digest-passport-js</a><br /></span></p>
<p></p>
<p>The first file works only to test in localhost (no need to use it at c9 or in a real server) because the domain of the request cannot be null. So if you clone the repo from github, the first thing you need to do is:</p>
<pre><code class="undefinedbash">$ node Server.js</code></pre>
<p>And then on your browser you must go to "<em><strong>localhost:2563</strong></em>" It will just serve you Httpdigest.html (where you only have to click the button.).</p>
<p><span class="quote">'Server.js'</span></p>
<pre><span class="reserved">var</span> express <span class="operator">=</span> require(<span>'express'</span>);
<span class="reserved">var</span> app <span class="operator">=</span> express();

app.all(<span class="quote">'/'</span>, <span class="reserved">function</span>(req, res) { res.sendfile(<span class="quote">'digest.html'</span>); } );

app.listen(<span class="number">2563</span>);
</pre>
<p></p>
<p>It's a simple html file that displays a button that calls the HttpDigest function.</p>
<p>IMPORTANT: for simplicity, I've omitted the token generation. This token should be generated via sdk and also be different in each call. Otherwise, it can be easily intercepted.</p>
<p></p>
<p>The process consists basically of 2 http requests as detailed here: <a href="http://en.wikipedia.org/wiki/Digest_access_authentication" title="http digest wikipedia">http://en.wikipedia.org/wiki/Digest_access_authentication</a></p>
<p>You can ignore the first part of the script. It is the md5 algorithm compressed.</p>
<p><span class="quote">'HttpDigest.html'</span></p>
<pre><span class="ltgt">&lt;!<span class="ltgt"><span class="reserved">DOCTYPE</span> html</span>&gt;</span>
<span class="ltgt">&lt;<span class="reserved">html</span>&gt;</span>
    <span class="ltgt">&lt;<span class="reserved">head</span>&gt;</span>
        &lt;<span class="reserved">style</span>&gt; <span class="reserved">body</span> { font-family: consolas} <span class="reserved">table</span> { border-collapse:collapse; } <span class="reserved">table</span>, <span class="reserved">td</span>, <span class="reserved">th</span> { border:1px solid black;} <span class="reserved">td</span><span>.H</span> { text-align: center; } &lt;/<span class="reserved">style</span>&gt;
        &lt;<span class="reserved">script</span> <span class="attr">src</span>=<span class="quote">"http://code.jquery.com/jquery-latest.js"</span>&gt;&lt;/<span class="reserved">script</span>&gt;
        &lt;<span class="reserved">script</span>&gt;
            <span class="reserved">var</span> hexcase<span class="operator">=</span><span class="number">0</span>;<span class="reserved">var</span> b64pad<span class="operator">=</span><span class="quote">""</span>;<span class="reserved">function</span> <span class="funcName">hex_md5</span>(a){<span class="operator">return</span> rstr2hex(rstr_md5(str2rstr_utf8(a)))}<span class="reserved">function</span> <span class="funcName">b64_md5</span>(a){<span class="operator">return</span> rstr2b64(rstr_md5(str2rstr_utf8(a)))}<span class="reserved">function</span> <span class="funcName">any_md5</span>(a,b){<span class="operator">return</span> rstr2any(rstr_md5(str2rstr_utf8(a)),b)}<span class="reserved">function</span> <span class="funcName">hex_hmac_md5</span>(a,b){<span class="operator">return</span> rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}<span class="reserved">function</span> <span class="funcName">b64_hmac_md5</span>(a,b){<span class="operator">return</span> rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}<span class="reserved">function</span> <span class="funcName">any_hmac_md5</span>(a,c,b){<span class="operator">return</span> rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(c)),b)}<span class="reserved">function</span> <span class="funcName">md5_vm_test</span>(){<span class="operator">return</span> hex_md5(<span class="quote">"abc"</span>).<span class="methodName">toLowerCase</span>()<span class="operator">==</span><span class="quote">"900150983cd24fb0d6963f7d28e17f72"</span>}<span class="reserved">function</span> <span class="funcName">rstr_md5</span>(a){<span class="operator">return</span> binl2rstr(binl_md5(rstr2binl(a),a.<span class="methodName">length</span><span class="operator">*</span><span class="number">8</span>))}<span class="reserved">function</span> <span class="funcName">rstr_hmac_md5</span>(c,f){<span class="reserved">var</span> e<span class="operator">=</span>rstr2binl(c);<span class="operator">if</span>(e.<span class="methodName">length</span><span class="operator">&gt;</span><span class="number">16</span>){e<span class="operator">=</span>binl_md5(e,c.<span class="methodName">length</span><span class="operator">*</span><span class="number">8</span>)}<span class="reserved">var</span> a<span class="operator">=</span><span class="methodName">Array</span>(<span class="number">16</span>),d<span class="operator">=</span><span class="methodName">Array</span>(<span class="number">16</span>);<span class="operator">for</span>(<span class="reserved">var</span> b<span class="operator">=</span><span class="number">0</span>;b<span class="operator">&lt;</span><span class="number">16</span>;b<span class="operator">++</span>){a[b]<span class="operator">=</span>e[b]^<span class="number">909522486</span>;d[b]<span class="operator">=</span>e[b]^<span class="number">1549556828</span>}<span class="reserved">var</span> g<span class="operator">=</span>binl_md5(a.<span class="methodName">concat</span>(rstr2binl(f)),<span class="number">512</span><span class="operator">+</span>f.<span class="methodName">length</span><span class="operator">*</span><span class="number">8</span>);<span class="operator">return</span> binl2rstr(binl_md5(d.<span class="methodName">concat</span>(g),<span class="number">512</span><span class="operator">+</span><span class="number">128</span>))}<span class="reserved">function</span> <span class="funcName">rstr2hex</span>(c){<span class="operator">try</span>{hexcase}<span class="operator">catch</span>(g){hexcase<span class="operator">=</span><span class="number">0</span>}<span class="reserved">var</span> f<span class="operator">=</span>hexcase?<span class="quote">"0123456789ABCDEF"</span>:<span class="quote">"0123456789abcdef"</span>;<span class="reserved">var</span> b<span class="operator">=</span><span class="quote">""</span>;<span class="reserved">var</span> a;<span class="operator">for</span>(<span class="reserved">var</span> d<span class="operator">=</span><span class="number">0</span>;d<span class="operator">&lt;</span>c.<span class="methodName">length</span>;d<span class="operator">++</span>){a<span class="operator">=</span>c.<span class="methodName">charCodeAt</span>(d);b<span class="operator">+</span><span class="operator">=</span>f.<span class="methodName">charAt</span>((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">4</span>)<span class="operator">&amp;</span><span class="number">15</span>)<span class="operator">+</span>f.<span class="methodName">charAt</span>(a<span class="operator">&amp;</span><span class="number">15</span>)}<span class="operator">return</span> b}<span class="reserved">function</span> <span class="funcName">rstr2b64</span>(c){<span class="operator">try</span>{b64pad}<span class="operator">catch</span>(h){b64pad<span class="operator">=</span><span class="quote">""</span>}<span class="reserved">var</span> g<span class="operator">=</span><span class="quote">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span>;<span class="reserved">var</span> b<span class="operator">=</span><span class="quote">""</span>;<span class="reserved">var</span> a<span class="operator">=</span>c.<span class="methodName">length</span>;<span class="operator">for</span>(<span class="reserved">var</span> f<span class="operator">=</span><span class="number">0</span>;f<span class="operator">&lt;</span>a;f<span class="operator">+</span><span class="operator">=</span><span class="number">3</span>){<span class="reserved">var</span> k<span class="operator">=</span>(c.<span class="methodName">charCodeAt</span>(f)<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">16</span>)|(f<span class="operator">+</span><span class="number">1</span><span class="operator">&lt;</span>a?c.<span class="methodName">charCodeAt</span>(f<span class="operator">+</span><span class="number">1</span>)<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">8</span>:<span class="number">0</span>)|(f<span class="operator">+</span><span class="number">2</span><span class="operator">&lt;</span>a?c.<span class="methodName">charCodeAt</span>(f<span class="operator">+</span><span class="number">2</span>):<span class="number">0</span>);<span class="operator">for</span>(<span class="reserved">var</span> d<span class="operator">=</span><span class="number">0</span>;d<span class="operator">&lt;</span><span class="number">4</span>;d<span class="operator">++</span>){<span class="operator">if</span>(f<span class="operator">*</span><span class="number">8</span><span class="operator">+</span>d<span class="operator">*</span><span class="number">6</span><span class="operator">&gt;</span>c.<span class="methodName">length</span><span class="operator">*</span><span class="number">8</span>){b<span class="operator">+</span><span class="operator">=</span>b64pad}<span class="operator">else</span>{b<span class="operator">+</span><span class="operator">=</span>g.<span class="methodName">charAt</span>((k<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">6</span><span class="operator">*</span>(<span class="number">3</span><span class="operator">-</span>d))<span class="operator">&amp;</span><span class="number">63</span>)}}}<span class="operator">return</span> b}<span class="reserved">function</span> <span class="funcName">rstr2any</span>(m,c){<span class="reserved">var</span> b<span class="operator">=</span>c.<span class="methodName">length</span>;<span class="reserved">var</span> l,f,a,n,e;<span class="reserved">var</span> k<span class="operator">=</span><span class="methodName">Array</span>(<span class="methodName">Math</span>.<span class="methodName">ceil</span>(m.<span class="methodName">length</span>/<span class="number">2</span>));<span class="operator">for</span>(l<span class="operator">=</span><span class="number">0</span>;l<span class="operator">&lt;</span>k.<span class="methodName">length</span>;l<span class="operator">++</span>){k[l]<span class="operator">=</span>(m.<span class="methodName">charCodeAt</span>(l<span class="operator">*</span><span class="number">2</span>)<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">8</span>)|m.<span class="methodName">charCodeAt</span>(l<span class="operator">*</span><span class="number">2</span><span class="operator">+</span><span class="number">1</span>)}<span class="reserved">var</span> h<span class="operator">=</span><span class="methodName">Math</span>.<span class="methodName">ceil</span>(m.<span class="methodName">length</span><span class="operator">*</span><span class="number">8</span>/(<span class="methodName">Math</span><span class="methodName">.log</span>(c.<span class="methodName">length</span>)/<span class="methodName">Math</span><span class="methodName">.log</span>(<span class="number">2</span>)));<span class="reserved">var</span> g<span class="operator">=</span><span class="methodName">Array</span>(h);<span class="operator">for</span>(f<span class="operator">=</span><span class="number">0</span>;f<span class="operator">&lt;</span>h;f<span class="operator">++</span>){e<span class="operator">=</span><span class="methodName">Array</span>();n<span class="operator">=</span><span class="number">0</span>;<span class="operator">for</span>(l<span class="operator">=</span><span class="number">0</span>;l<span class="operator">&lt;</span>k.<span class="methodName">length</span>;l<span class="operator">++</span>){n<span class="operator">=</span>(n<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">16</span>)<span class="operator">+</span>k[l];a<span class="operator">=</span><span class="methodName">Math</span>.<span class="methodName">floor</span>(n/b);n<span class="operator">-</span><span class="operator">=</span>a<span class="operator">*</span>b;<span class="operator">if</span>(e.<span class="methodName">length</span><span class="operator">&gt;</span><span class="number">0</span><span class="operator">||</span>a<span class="operator">&gt;</span><span class="number">0</span>){e[e.<span class="methodName">length</span>]<span class="operator">=</span>a}}g[f]<span class="operator">=</span>n;k<span class="operator">=</span>e}<span class="reserved">var</span> d<span class="operator">=</span><span class="quote">""</span>;<span class="operator">for</span>(l<span class="operator">=</span>g.<span class="methodName">length</span><span class="operator">-</span><span class="number">1</span>;l<span class="operator">&gt;=</span><span class="number">0</span>;l<span class="operator">--</span>){d<span class="operator">+</span><span class="operator">=</span>c.<span class="methodName">charAt</span>(g[l])}<span class="operator">return</span> d}<span class="reserved">function</span> <span class="funcName">str2rstr_utf8</span>(c){<span class="reserved">var</span> b<span class="operator">=</span><span class="quote">""</span>;<span class="reserved">var</span> d<span class="operator">=</span><span class="operator">-</span><span class="number">1</span>;<span class="reserved">var</span> a,e;<span class="operator">while</span>(<span class="operator">++</span>d<span class="operator">&lt;</span>c.<span class="methodName">length</span>){a<span class="operator">=</span>c.<span class="methodName">charCodeAt</span>(d);e<span class="operator">=</span>d<span class="operator">+</span><span class="number">1</span><span class="operator">&lt;</span>c.<span class="methodName">length</span>?c.<span class="methodName">charCodeAt</span>(d<span class="operator">+</span><span class="number">1</span>):<span class="number">0</span>;<span class="operator">if</span>(<span class="number">55296</span><span class="operator">&lt;=</span>a<span class="operator">&amp;</span><span class="operator">&amp;</span>a<span class="operator">&lt;=</span><span class="number">56319</span><span class="operator">&amp;</span><span class="operator">&amp;</span><span class="number">56320</span><span class="operator">&lt;=</span>e<span class="operator">&amp;</span><span class="operator">&amp;</span>e<span class="operator">&lt;=</span><span class="number">57343</span>){a<span class="operator">=</span><span class="number">65536</span><span class="operator">+</span>((a<span class="operator">&amp;</span><span class="number">1023</span>)<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">10</span>)<span class="operator">+</span>(e<span class="operator">&amp;</span><span class="number">1023</span>);d<span class="operator">++</span>}<span class="operator">if</span>(a<span class="operator">&lt;=</span><span class="number">127</span>){b<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>(a)}<span class="operator">else</span>{<span class="operator">if</span>(a<span class="operator">&lt;=</span><span class="number">2047</span>){b<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>(<span class="number">192</span>|((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">6</span>)<span class="operator">&amp;</span><span class="number">31</span>),<span class="number">128</span>|(a<span class="operator">&amp;</span><span class="number">63</span>))}<span class="operator">else</span>{<span class="operator">if</span>(a<span class="operator">&lt;=</span><span class="number">65535</span>){b<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>(<span class="number">224</span>|((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">12</span>)<span class="operator">&amp;</span><span class="number">15</span>),<span class="number">128</span>|((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">6</span>)<span class="operator">&amp;</span><span class="number">63</span>),<span class="number">128</span>|(a<span class="operator">&amp;</span><span class="number">63</span>))}<span class="operator">else</span>{<span class="operator">if</span>(a<span class="operator">&lt;=</span><span class="number">2097151</span>){b<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>(<span class="number">240</span>|((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">18</span>)<span class="operator">&amp;</span><span class="number">7</span>),<span class="number">128</span>|((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">12</span>)<span class="operator">&amp;</span><span class="number">63</span>),<span class="number">128</span>|((a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">6</span>)<span class="operator">&amp;</span><span class="number">63</span>),<span class="number">128</span>|(a<span class="operator">&amp;</span><span class="number">63</span>))}}}}}<span class="operator">return</span> b}<span class="reserved">function</span> <span class="funcName">str2rstr_utf16le</span>(b){<span class="reserved">var</span> a<span class="operator">=</span><span class="quote">""</span>;<span class="operator">for</span>(<span class="reserved">var</span> c<span class="operator">=</span><span class="number">0</span>;c<span class="operator">&lt;</span>b.<span class="methodName">length</span>;c<span class="operator">++</span>){a<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>(b.<span class="methodName">charCodeAt</span>(c)<span class="operator">&amp;</span><span class="number">255</span>,(b.<span class="methodName">charCodeAt</span>(c)<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">8</span>)<span class="operator">&amp;</span><span class="number">255</span>)}<span class="operator">return</span> a}<span class="reserved">function</span> <span class="funcName">str2rstr_utf16be</span>(b){<span class="reserved">var</span> a<span class="operator">=</span><span class="quote">""</span>;<span class="operator">for</span>(<span class="reserved">var</span> c<span class="operator">=</span><span class="number">0</span>;c<span class="operator">&lt;</span>b.<span class="methodName">length</span>;c<span class="operator">++</span>){a<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>((b.<span class="methodName">charCodeAt</span>(c)<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">8</span>)<span class="operator">&amp;</span><span class="number">255</span>,b.<span class="methodName">charCodeAt</span>(c)<span class="operator">&amp;</span><span class="number">255</span>)}<span class="operator">return</span> a}<span class="reserved">function</span> <span class="funcName">rstr2binl</span>(b){<span class="reserved">var</span> a<span class="operator">=</span><span class="methodName">Array</span>(b.<span class="methodName">length</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">2</span>);<span class="operator">for</span>(<span class="reserved">var</span> c<span class="operator">=</span><span class="number">0</span>;c<span class="operator">&lt;</span>a.<span class="methodName">length</span>;c<span class="operator">++</span>){a[c]<span class="operator">=</span><span class="number">0</span>}<span class="operator">for</span>(<span class="reserved">var</span> c<span class="operator">=</span><span class="number">0</span>;c<span class="operator">&lt;</span>b.<span class="methodName">length</span><span class="operator">*</span><span class="number">8</span>;c<span class="operator">+</span><span class="operator">=</span><span class="number">8</span>){a[c<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">5</span>]|<span class="operator">=</span>(b.<span class="methodName">charCodeAt</span>(c/<span class="number">8</span>)<span class="operator">&amp;</span><span class="number">255</span>)<span class="operator">&lt;</span><span class="operator">&lt;</span>(c<span class="operator">%</span><span class="number">32</span>)}<span class="operator">return</span> a}<span class="reserved">function</span> <span class="funcName">binl2rstr</span>(b){<span class="reserved">var</span> a<span class="operator">=</span><span class="quote">""</span>;<span class="operator">for</span>(<span class="reserved">var</span> c<span class="operator">=</span><span class="number">0</span>;c<span class="operator">&lt;</span>b.<span class="methodName">length</span><span class="operator">*</span><span class="number">32</span>;c<span class="operator">+</span><span class="operator">=</span><span class="number">8</span>){a<span class="operator">+</span><span class="operator">=</span><span class="methodName">String</span>.<span class="methodName">fromCharCode</span>((b[c<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">5</span>]<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>(c<span class="operator">%</span><span class="number">32</span>))<span class="operator">&amp;</span><span class="number">255</span>)}<span class="operator">return</span> a}<span class="reserved">function</span> <span class="funcName">binl_md5</span>(p,k){p[k<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">5</span>]|<span class="operator">=</span><span class="number">128</span><span class="operator">&lt;</span><span class="operator">&lt;</span>((k)<span class="operator">%</span><span class="number">32</span>);p[(((k<span class="operator">+</span><span class="number">64</span>)<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">9</span>)<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">4</span>)<span class="operator">+</span><span class="number">14</span>]<span class="operator">=</span>k;<span class="reserved">var</span> o<span class="operator">=</span><span class="number">1732584193</span>;<span class="reserved">var</span> n<span class="operator">=</span><span class="operator">-</span><span class="number">271733879</span>;<span class="reserved">var</span> m<span class="operator">=</span><span class="operator">-</span><span class="number">1732584194</span>;<span class="reserved">var</span> l<span class="operator">=</span><span class="number">271733878</span>;<span class="operator">for</span>(<span class="reserved">var</span> g<span class="operator">=</span><span class="number">0</span>;g<span class="operator">&lt;</span>p.<span class="methodName">length</span>;g<span class="operator">+</span><span class="operator">=</span><span class="number">16</span>){<span class="reserved">var</span> j<span class="operator">=</span>o;<span class="reserved">var</span> h<span class="operator">=</span>n;<span class="reserved">var</span> f<span class="operator">=</span>m;<span class="reserved">var</span> e<span class="operator">=</span>l;o<span class="operator">=</span>md5_ff(o,n,m,l,p[g<span class="operator">+</span><span class="number">0</span>],<span class="number">7</span>,<span class="operator">-</span><span class="number">680876936</span>);l<span class="operator">=</span>md5_ff(l,o,n,m,p[g<span class="operator">+</span><span class="number">1</span>],<span class="number">12</span>,<span class="operator">-</span><span class="number">389564586</span>);m<span class="operator">=</span>md5_ff(m,l,o,n,p[g<span class="operator">+</span><span class="number">2</span>],<span class="number">17</span>,<span class="number">606105819</span>);n<span class="operator">=</span>md5_ff(n,m,l,o,p[g<span class="operator">+</span><span class="number">3</span>],<span class="number">22</span>,<span class="operator">-</span><span class="number">1044525330</span>);o<span class="operator">=</span>md5_ff(o,n,m,l,p[g<span class="operator">+</span><span class="number">4</span>],<span class="number">7</span>,<span class="operator">-</span><span class="number">176418897</span>);l<span class="operator">=</span>md5_ff(l,o,n,m,p[g<span class="operator">+</span><span class="number">5</span>],<span class="number">12</span>,<span class="number">1200080426</span>);m<span class="operator">=</span>md5_ff(m,l,o,n,p[g<span class="operator">+</span><span class="number">6</span>],<span class="number">17</span>,<span class="operator">-</span><span class="number">1473231341</span>);n<span class="operator">=</span>md5_ff(n,m,l,o,p[g<span class="operator">+</span><span class="number">7</span>],<span class="number">22</span>,<span class="operator">-</span><span class="number">45705983</span>);o<span class="operator">=</span>md5_ff(o,n,m,l,p[g<span class="operator">+</span><span class="number">8</span>],<span class="number">7</span>,<span class="number">1770035416</span>);l<span class="operator">=</span>md5_ff(l,o,n,m,p[g<span class="operator">+</span><span class="number">9</span>],<span class="number">12</span>,<span class="operator">-</span><span class="number">1958414417</span>);m<span class="operator">=</span>md5_ff(m,l,o,n,p[g<span class="operator">+</span><span class="number">10</span>],<span class="number">17</span>,<span class="operator">-</span><span class="number">42063</span>);n<span class="operator">=</span>md5_ff(n,m,l,o,p[g<span class="operator">+</span><span class="number">11</span>],<span class="number">22</span>,<span class="operator">-</span><span class="number">1990404162</span>);o<span class="operator">=</span>md5_ff(o,n,m,l,p[g<span class="operator">+</span><span class="number">12</span>],<span class="number">7</span>,<span class="number">1804603682</span>);l<span class="operator">=</span>md5_ff(l,o,n,m,p[g<span class="operator">+</span><span class="number">13</span>],<span class="number">12</span>,<span class="operator">-</span><span class="number">40341101</span>);m<span class="operator">=</span>md5_ff(m,l,o,n,p[g<span class="operator">+</span><span class="number">14</span>],<span class="number">17</span>,<span class="operator">-</span><span class="number">1502002290</span>);n<span class="operator">=</span>md5_ff(n,m,l,o,p[g<span class="operator">+</span><span class="number">15</span>],<span class="number">22</span>,<span class="number">1236535329</span>);o<span class="operator">=</span>md5_gg(o,n,m,l,p[g<span class="operator">+</span><span class="number">1</span>],<span class="number">5</span>,<span class="operator">-</span><span class="number">165796510</span>);l<span class="operator">=</span>md5_gg(l,o,n,m,p[g<span class="operator">+</span><span class="number">6</span>],<span class="number">9</span>,<span class="operator">-</span><span class="number">1069501632</span>);m<span class="operator">=</span>md5_gg(m,l,o,n,p[g<span class="operator">+</span><span class="number">11</span>],<span class="number">14</span>,<span class="number">643717713</span>);n<span class="operator">=</span>md5_gg(n,m,l,o,p[g<span class="operator">+</span><span class="number">0</span>],<span class="number">20</span>,<span class="operator">-</span><span class="number">373897302</span>);o<span class="operator">=</span>md5_gg(o,n,m,l,p[g<span class="operator">+</span><span class="number">5</span>],<span class="number">5</span>,<span class="operator">-</span><span class="number">701558691</span>);l<span class="operator">=</span>md5_gg(l,o,n,m,p[g<span class="operator">+</span><span class="number">10</span>],<span class="number">9</span>,<span class="number">38016083</span>);m<span class="operator">=</span>md5_gg(m,l,o,n,p[g<span class="operator">+</span><span class="number">15</span>],<span class="number">14</span>,<span class="operator">-</span><span class="number">660478335</span>);n<span class="operator">=</span>md5_gg(n,m,l,o,p[g<span class="operator">+</span><span class="number">4</span>],<span class="number">20</span>,<span class="operator">-</span><span class="number">405537848</span>);o<span class="operator">=</span>md5_gg(o,n,m,l,p[g<span class="operator">+</span><span class="number">9</span>],<span class="number">5</span>,<span class="number">568446438</span>);l<span class="operator">=</span>md5_gg(l,o,n,m,p[g<span class="operator">+</span><span class="number">14</span>],<span class="number">9</span>,<span class="operator">-</span><span class="number">1019803690</span>);m<span class="operator">=</span>md5_gg(m,l,o,n,p[g<span class="operator">+</span><span class="number">3</span>],<span class="number">14</span>,<span class="operator">-</span><span class="number">187363961</span>);n<span class="operator">=</span>md5_gg(n,m,l,o,p[g<span class="operator">+</span><span class="number">8</span>],<span class="number">20</span>,<span class="number">1163531501</span>);o<span class="operator">=</span>md5_gg(o,n,m,l,p[g<span class="operator">+</span><span class="number">13</span>],<span class="number">5</span>,<span class="operator">-</span><span class="number">1444681467</span>);l<span class="operator">=</span>md5_gg(l,o,n,m,p[g<span class="operator">+</span><span class="number">2</span>],<span class="number">9</span>,<span class="operator">-</span><span class="number">51403784</span>);m<span class="operator">=</span>md5_gg(m,l,o,n,p[g<span class="operator">+</span><span class="number">7</span>],<span class="number">14</span>,<span class="number">1735328473</span>);n<span class="operator">=</span>md5_gg(n,m,l,o,p[g<span class="operator">+</span><span class="number">12</span>],<span class="number">20</span>,<span class="operator">-</span><span class="number">1926607734</span>);o<span class="operator">=</span>md5_hh(o,n,m,l,p[g<span class="operator">+</span><span class="number">5</span>],<span class="number">4</span>,<span class="operator">-</span><span class="number">378558</span>);l<span class="operator">=</span>md5_hh(l,o,n,m,p[g<span class="operator">+</span><span class="number">8</span>],<span class="number">11</span>,<span class="operator">-</span><span class="number">2022574463</span>);m<span class="operator">=</span>md5_hh(m,l,o,n,p[g<span class="operator">+</span><span class="number">11</span>],<span class="number">16</span>,<span class="number">1839030562</span>);n<span class="operator">=</span>md5_hh(n,m,l,o,p[g<span class="operator">+</span><span class="number">14</span>],<span class="number">23</span>,<span class="operator">-</span><span class="number">35309556</span>);o<span class="operator">=</span>md5_hh(o,n,m,l,p[g<span class="operator">+</span><span class="number">1</span>],<span class="number">4</span>,<span class="operator">-</span><span class="number">1530992060</span>);l<span class="operator">=</span>md5_hh(l,o,n,m,p[g<span class="operator">+</span><span class="number">4</span>],<span class="number">11</span>,<span class="number">1272893353</span>);m<span class="operator">=</span>md5_hh(m,l,o,n,p[g<span class="operator">+</span><span class="number">7</span>],<span class="number">16</span>,<span class="operator">-</span><span class="number">155497632</span>);n<span class="operator">=</span>md5_hh(n,m,l,o,p[g<span class="operator">+</span><span class="number">10</span>],<span class="number">23</span>,<span class="operator">-</span><span class="number">1094730640</span>);o<span class="operator">=</span>md5_hh(o,n,m,l,p[g<span class="operator">+</span><span class="number">13</span>],<span class="number">4</span>,<span class="number">681279174</span>);l<span class="operator">=</span>md5_hh(l,o,n,m,p[g<span class="operator">+</span><span class="number">0</span>],<span class="number">11</span>,<span class="operator">-</span><span class="number">358537222</span>);m<span class="operator">=</span>md5_hh(m,l,o,n,p[g<span class="operator">+</span><span class="number">3</span>],<span class="number">16</span>,<span class="operator">-</span><span class="number">722521979</span>);n<span class="operator">=</span>md5_hh(n,m,l,o,p[g<span class="operator">+</span><span class="number">6</span>],<span class="number">23</span>,<span class="number">76029189</span>);o<span class="operator">=</span>md5_hh(o,n,m,l,p[g<span class="operator">+</span><span class="number">9</span>],<span class="number">4</span>,<span class="operator">-</span><span class="number">640364487</span>);l<span class="operator">=</span>md5_hh(l,o,n,m,p[g<span class="operator">+</span><span class="number">12</span>],<span class="number">11</span>,<span class="operator">-</span><span class="number">421815835</span>);m<span class="operator">=</span>md5_hh(m,l,o,n,p[g<span class="operator">+</span><span class="number">15</span>],<span class="number">16</span>,<span class="number">530742520</span>);n<span class="operator">=</span>md5_hh(n,m,l,o,p[g<span class="operator">+</span><span class="number">2</span>],<span class="number">23</span>,<span class="operator">-</span><span class="number">995338651</span>);o<span class="operator">=</span>md5_ii(o,n,m,l,p[g<span class="operator">+</span><span class="number">0</span>],<span class="number">6</span>,<span class="operator">-</span><span class="number">198630844</span>);l<span class="operator">=</span>md5_ii(l,o,n,m,p[g<span class="operator">+</span><span class="number">7</span>],<span class="number">10</span>,<span class="number">1126891415</span>);m<span class="operator">=</span>md5_ii(m,l,o,n,p[g<span class="operator">+</span><span class="number">14</span>],<span class="number">15</span>,<span class="operator">-</span><span class="number">1416354905</span>);n<span class="operator">=</span>md5_ii(n,m,l,o,p[g<span class="operator">+</span><span class="number">5</span>],<span class="number">21</span>,<span class="operator">-</span><span class="number">57434055</span>);o<span class="operator">=</span>md5_ii(o,n,m,l,p[g<span class="operator">+</span><span class="number">12</span>],<span class="number">6</span>,<span class="number">1700485571</span>);l<span class="operator">=</span>md5_ii(l,o,n,m,p[g<span class="operator">+</span><span class="number">3</span>],<span class="number">10</span>,<span class="operator">-</span><span class="number">1894986606</span>);m<span class="operator">=</span>md5_ii(m,l,o,n,p[g<span class="operator">+</span><span class="number">10</span>],<span class="number">15</span>,<span class="operator">-</span><span class="number">1051523</span>);n<span class="operator">=</span>md5_ii(n,m,l,o,p[g<span class="operator">+</span><span class="number">1</span>],<span class="number">21</span>,<span class="operator">-</span><span class="number">2054922799</span>);o<span class="operator">=</span>md5_ii(o,n,m,l,p[g<span class="operator">+</span><span class="number">8</span>],<span class="number">6</span>,<span class="number">1873313359</span>);l<span class="operator">=</span>md5_ii(l,o,n,m,p[g<span class="operator">+</span><span class="number">15</span>],<span class="number">10</span>,<span class="operator">-</span><span class="number">30611744</span>);m<span class="operator">=</span>md5_ii(m,l,o,n,p[g<span class="operator">+</span><span class="number">6</span>],<span class="number">15</span>,<span class="operator">-</span><span class="number">1560198380</span>);n<span class="operator">=</span>md5_ii(n,m,l,o,p[g<span class="operator">+</span><span class="number">13</span>],<span class="number">21</span>,<span class="number">1309151649</span>);o<span class="operator">=</span>md5_ii(o,n,m,l,p[g<span class="operator">+</span><span class="number">4</span>],<span class="number">6</span>,<span class="operator">-</span><span class="number">145523070</span>);l<span class="operator">=</span>md5_ii(l,o,n,m,p[g<span class="operator">+</span><span class="number">11</span>],<span class="number">10</span>,<span class="operator">-</span><span class="number">1120210379</span>);m<span class="operator">=</span>md5_ii(m,l,o,n,p[g<span class="operator">+</span><span class="number">2</span>],<span class="number">15</span>,<span class="number">718787259</span>);n<span class="operator">=</span>md5_ii(n,m,l,o,p[g<span class="operator">+</span><span class="number">9</span>],<span class="number">21</span>,<span class="operator">-</span><span class="number">343485551</span>);o<span class="operator">=</span>safe_add(o,j);n<span class="operator">=</span>safe_add(n,h);m<span class="operator">=</span>safe_add(m,f);l<span class="operator">=</span>safe_add(l,e)}<span class="operator">return</span> <span class="methodName">Array</span>(o,n,m,l)}<span class="reserved">function</span> <span class="funcName">md5_cmn</span>(h,e,d,c,g,f){<span class="operator">return</span> safe_add(bit_rol(safe_add(safe_add(e,h),safe_add(c,f)),g),d)}<span class="reserved">function</span> <span class="funcName">md5_ff</span>(g,f,k,j,e,i,h){<span class="operator">return</span> md5_cmn((f<span class="operator">&amp;</span>k)|((<span class="operator">~</span>f)<span class="operator">&amp;</span>j),g,f,e,i,h)}<span class="reserved">function</span> <span class="funcName">md5_gg</span>(g,f,k,j,e,i,h){<span class="operator">return</span> md5_cmn((f<span class="operator">&amp;</span>j)|(k<span class="operator">&amp;</span>(<span class="operator">~</span>j)),g,f,e,i,h)}<span class="reserved">function</span> <span class="funcName">md5_hh</span>(g,f,k,j,e,i,h){<span class="operator">return</span> md5_cmn(f^k^j,g,f,e,i,h)}<span class="reserved">function</span> <span class="funcName">md5_ii</span>(g,f,k,j,e,i,h){<span class="operator">return</span> md5_cmn(k^(f|(<span class="operator">~</span>j)),g,f,e,i,h)}<span class="reserved">function</span> <span class="funcName">safe_add</span>(a,d){<span class="reserved">var</span> c<span class="operator">=</span>(a<span class="operator">&amp;</span><span class="number">65535</span>)<span class="operator">+</span>(d<span class="operator">&amp;</span><span class="number">65535</span>);<span class="reserved">var</span> b<span class="operator">=</span>(a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">16</span>)<span class="operator">+</span>(d<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">16</span>)<span class="operator">+</span>(c<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="number">16</span>);<span class="operator">return</span>(b<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="number">16</span>)|(c<span class="operator">&amp;</span><span class="number">65535</span>)}<span class="reserved">function</span> <span class="funcName">bit_rol</span>(a,b){<span class="operator">return</span>(a<span class="operator">&lt;</span><span class="operator">&lt;</span>b)|(a<span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span>(<span class="number">32</span><span class="operator">-</span>b))};

            <span class="reserved">function</span> <span class="funcName">genNonce</span>(b){<span class="reserved">var</span> c<span class="operator">=</span>[],e<span class="operator">=</span><span class="quote">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>,a<span class="operator">=</span>e.<span class="methodName">length</span>;<span class="operator">for</span>(<span class="reserved">var</span> d<span class="operator">=</span><span class="number">0</span>;d<span class="operator">&lt;</span>b;<span class="operator">++</span>d){c.<span class="methodName">push</span>(e[<span class="methodName">Math</span>.<span class="methodName">random</span>()<span class="operator">*</span>a|<span class="number">0</span>])}<span class="operator">return</span> c.<span class="methodName">join</span>(<span class="quote">""</span>)};
            
            <span class="operator">$</span>(<span class="reserved">function</span>()
            {
                <span class="operator">$</span>(<span class="quote">'#btn'</span>).<span class="methodName">click</span>(
                    <span class="reserved">function</span>() { HttpDigest(<span class="quote">"John"</span>, <span class="quote">'pass'</span>, <span class="quote">'http://localhost:3000'</span>, <span class="quote">'/'</span>, <span class="reserved">function</span>(d){ <span>console</span><span class="methodName">.log</span>(d) } ); }
                );
            });
            
            <span class="comment">//function addInfo( key, val ) { $('#data').append( '&lt;tr&gt;&lt;td class="H"&gt;&lt;b&gt;' + key + '&lt;/b&gt;&amp;nbsp&amp;nbsp&lt;/td&gt;&lt;td&gt;' + val + '&lt;/td&gt;&lt;/tr&gt;' ); }</span>
            
            <span class="reserved">function</span> <span class="funcName">HttpDigest</span>( USER, TOKEN, URL, URI, callback )
            {
                <span class="reserved">var</span> nonce,  <span class="comment">// unique string value specified by the server</span>
                    realm,  <span class="comment">// authentication realm, defaults to "IsmuserAPI"</span>
                    qop;    <span class="comment">// list of quality of protection values supported by the server (auth | auth-int); auth set.</span>
                
                <span class="reserved">var</span> cnonce  <span class="operator">=</span> genNonce( <span class="number">10</span> ); <span class="comment">// opaque random string value provided by the client</span>
                <span class="reserved">var</span> nc      <span class="operator">=</span> <span class="number">0</span>;              <span class="comment">// count of the number of requests (including the current request) that the client has sent with the nonce value</span>
                
                <span class="comment">/* 
                 * Simple tokenization to start with:
                 *
                 * This will turn a WWW-Authenticate header field like:

                 * WWW-Authenticate: Digest realm="your.realm",
                                            qop="auth",
                                            nonce="dcd98b7102dd2f0e8b11d0f600bfb0c093"
                 * into:
                 *
                 *  ['Digest', 'realm="your.realm"', 'qop="auth"', 'nonce="dcd98b7102dd2f0e8b11d0f600bfb0c093"']
                 */</span>
                <span class="reserved">var</span> ws      <span class="operator">=</span> <span class="quote">'(?:(?:<span class="methodName">\\</span>r<span class="methodName">\\</span>n)?[ <span class="methodName">\\</span>t])+'</span>,
                    token   <span class="operator">=</span> <span class="quote">'(?:[<span class="methodName">\\</span>x21<span class="methodName">\\</span>x23-<span class="methodName">\\</span>x27<span class="methodName">\\</span>x2A<span class="methodName">\\</span>x2B<span class="methodName">\\</span>x2D<span class="methodName">\\</span>x2E<span class="methodName">\\</span>x30-<span class="methodName">\\</span>x39<span class="methodName">\\</span>x3F<span class="methodName">\\</span>x41-<span class="methodName">\\</span>x5A<span class="methodName">\\</span>x5E-<span class="methodName">\\</span>x7A<span class="methodName">\\</span>x7C<span class="methodName">\\</span>x7E]+)'</span>,
                    quotedString <span class="operator">=</span> <span class="quote">'"(?:[<span class="methodName">\\</span>x00-<span class="methodName">\\</span>x0B<span class="methodName">\\</span>x0D-<span class="methodName">\\</span>x21<span class="methodName">\\</span>x23-<span class="methodName">\\</span>x5B<span class="methodName">\\</span><span class="methodName">\\</span>x5D-<span class="methodName">\\</span>x7F]|'</span><span class="operator">+</span>ws<span class="operator">+</span><span class="quote">'|<span class="methodName">\\</span><span class="methodName">\\</span>[<span class="methodName">\\</span>x00-<span class="methodName">\\</span>x7F])*"'</span>,
                    tokenizer <span class="operator">=</span> <span class="methodName">RegExp</span>(token<span class="operator">+</span><span class="quote">'(?:=(?:'</span><span class="operator">+</span>quotedString<span class="operator">+</span><span class="quote">'|'</span><span class="operator">+</span>token<span class="operator">+</span><span class="quote">'))?'</span>, <span class="quote">'g'</span>);
                    
                
                <span class="comment">// Parse the parameters (check existence and validity) and extract the values. </span>
                <span class="comment">// Note that quoted-string values can be folded, so you need to unfold them with this function                  </span>
                <span class="reserved">function</span> <span class="funcName">unq</span>(quotedString) { <span class="operator">return</span> quotedString.<span class="methodName">substr</span>(<span class="number">1</span>, quotedString.<span class="methodName">length</span><span class="operator">-</span><span class="number">2</span>).<span class="methodName">replace</span>(<span>/(?:(?:<span class="methodName">\r</span><span class="methodName">\n</span>)?[ <span class="methodName">\t</span>])+/g</span>, <span class="quote">" "</span>); }

                
                <span class="reserved">var</span> method  <span class="operator">=</span> <span class="quote">"GET"</span>;
                <span class="reserved">var</span> dType   <span class="operator">=</span> <span class="quote">"JSON"</span>;
                
                <span class="comment">// 1&ordm; ajax call, to get the cnonce (server nonce)</span>
                <span class="reserved">var</span> ajaxObj <span class="operator">=</span> <span class="operator">$</span>.ajax
                ({
                    url         : URL,
                    type        : method,
                    dataType    : dType,
                    crossDomain : <span class="bool">true</span>,
                    statusCode:
                    {
                        <span class="number">401</span>: <span class="reserved">function</span> () 
                        {
                            <span class="comment">// Read the HTTP authentication header to get the nonce, realm and qop</span>
                            <span class="reserved">var</span> tokens <span class="operator">=</span> ( ajaxObj.<span class="methodName">getResponseHeader</span>(<span class="quote">"WWW-Authenticate"</span>)
                                        <span class="comment">// this is nasty, ugly-looking and disgusting but necessary to cheat "the great Safari browser"</span>
                                        <span class="operator">||</span> ajaxObj.<span class="methodName">getResponseHeader</span>(<span class="quote">"Content-Type"</span>) ) 
                                            .<span class="methodName">match</span>(tokenizer);

                            <span class="operator">$</span>.each(tokens, <span class="reserved">function</span>(index, value)
                            {
                                <span class="operator">if</span> (value.match (<span class="quote">"WWW-Authenticate"</span>)) nonce <span class="operator">=</span> unq(value.<span class="methodName">split</span>(<span class="quote">'='</span>)[<span class="number">1</span>]);
                                <span class="operator">if</span> (value.match (<span class="quote">"realm"</span>))            realm <span class="operator">=</span> unq(value.<span class="methodName">split</span>(<span class="quote">'='</span>)[<span class="number">1</span>]);
                                <span class="operator">if</span> (value.match (<span class="quote">"qop"</span>))              qop   <span class="operator">=</span> unq(value.<span class="methodName">split</span>(<span class="quote">'='</span>)[<span class="number">1</span>]);
                            });
                            
                            <span class="comment">/*
                             * HA1 = MD5(USER:REALM:PASS) --&gt; john:your.realm:pass
                             */</span>
                            <span class="reserved">var</span> HA1 <span class="operator">=</span> hex_md5(USER <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> realm <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> TOKEN);
                            
                            <span class="comment">/*
                             * HA2 = MD5(METHOD:URI)--&gt; GET:your.realm
                             */</span>
                            <span class="reserved">var</span> HA2 <span class="operator">=</span> hex_md5(method <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> URI);
                            
                            <span class="comment">/*
                             * response = digest = MD5(HA1 + ":" + NONCE + ":" + NC + ":" + CNONCE + ":" + QOP + ":" + HA2);
                             */</span>
                            <span class="reserved">var</span> res <span class="operator">=</span> hex_md5(HA1 <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> nonce <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> nc <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> cnonce <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> qop <span class="operator">+</span> <span class="quote">":"</span> <span class="operator">+</span> HA2);

                            <span class="comment">/*
                             *  Authorization header:
                             *
                             *  Authorization:  Digest username="John", realm="your.realm", 
                                                nonce="k7KYbGJOCIw4RAK0IcaUQsYszXwsJGOU", uri="/", 
                                                cnonce="MDAwODM0", nc=00000001, qop="auth", 
                                                response="77f88f3f6b4623eedf17af206098ebf8"
                             */</span>
                            <span class="reserved">var</span> header <span class="operator">=</span> <span class="quote">'Digest username="'</span> <span class="operator">+</span> USER <span class="operator">+</span> <span class="quote">'", realm="'</span> <span class="operator">+</span> realm
                                        <span class="operator">+</span> <span class="quote">'", nonce="'</span> <span class="operator">+</span> nonce <span class="operator">+</span> <span class="quote">'", uri="'</span> <span class="operator">+</span> URI <span class="operator">+</span> <span class="quote">'", cnonce="'</span> 
                                        <span class="operator">+</span> cnonce <span class="operator">+</span> <span class="quote">'", nc="'</span> <span class="operator">+</span> nc <span class="operator">+</span> <span class="quote">'", qop="'</span> <span class="operator">+</span> qop <span class="operator">+</span> <span class="quote">'", response="'</span> 
                                        <span class="operator">+</span> res <span class="operator">+</span> <span class="quote">'"'</span>;

                            <span class="comment">// now we've already built the digest, let's make another request to the server to get the data</span>
                            <span class="reserved">var</span> request <span class="operator">=</span> <span class="operator">$</span>.ajax
                            ({
                                url         : URL,
                                type        : method,
                                dataType    : dType,
                                crossDomain : <span class="bool">true</span>,
                                contentType : <span class="quote">'application/json'</span>,
                                headers     : { <span class="quote">"Authorization"</span>: header }
                            })
                            .fail(<span class="reserved">function</span> ( jqXHR, status, error ) { callback( { status : status, error : error, statusCode : jqXHR.<span class="methodName">status</span> } ); })
                            .done(<span class="reserved">function</span> ( data, status, jqXHR )  { callback( data ); });
                        } <span class="comment">// end 401 status code</span>
                    } <span class="comment">// end statusCode</span>
                }); <span class="comment">// end ajaxCall</span>
            } <span class="comment">// end HttpDigest()</span>
            
        &lt;/<span class="reserved">script</span>&gt;
    <span class="ltgt">&lt;/<span class="reserved">head</span>&gt;</span>
    <span class="ltgt">&lt;<span class="reserved">body</span>&gt;</span>
        <span class="ltgt">&lt;<span class="reserved">center</span>&gt;</span>
            <span class="ltgt">&lt;<span class="reserved">p</span>&gt;</span> Http Digest <span class="ltgt">&lt;/<span class="reserved">p</span>&gt;</span>
            <span class="ltgt">&lt;<span class="reserved">button</span> <span class="attr">id</span>=<span class="quote">"btn"</span> <span class="attr">type</span>=<span class="quote">"button"</span>&gt;</span>Request<span class="ltgt">&lt;/<span class="reserved">button</span>&gt;</span>
            <span class="ltgt">&lt;<span class="reserved">table</span> <span class="attr">id</span>=<span class="quote">"data"</span>&gt;&lt;/<span class="reserved">table</span>&gt;</span>
        <span class="ltgt">&lt;/<span class="reserved">center</span>&gt;</span>
    <span class="ltgt">&lt;/<span class="reserved">body</span>&gt;</span>
<span class="ltgt">&lt;/<span class="reserved">html</span>&gt;</span>
</pre>
<p>App.js</p>
<p><span class="quote">'App.js'</span></p>
<pre><span class="reserved">var</span> express<span class="operator">=</span> require(<span class="quote">'express'</span>),
    passport       <span class="operator">=</span> require(<span class="quote">'passport'</span>), <span class="comment">// passportjs</span>
    DigestStrategy <span class="operator">=</span> require(<span class="quote">'passport-http'</span>).DigestStrategy; <span class="comment">// http digest</span>

<span class="comment">// #############################################################################################################</span>

<span class="comment">// ----------------</span>
<span class="comment">// Environment conf</span>
<span class="comment">// ----------------</span>
<span class="reserved">var</span> app <span class="operator">=</span> express();

<span class="comment">// configure Express</span>
app.configure(<span class="reserved">function</span>()
{
    app.use(express.logger());
<span class="comment"></span>
    app.use(express.methodOverride());
    
    <span class="comment">// Initialize Passport! Note: no need to use session middleware when each</span>
    <span class="comment">// request carries authentication credentials, as is the case with HTTP</span>
    <span class="comment">// Digest.</span>
    app.use(passport.initialize());
    
    app.use(app.router);
    app.use(express.<span class="reserved">static</span>( __dirname <span class="operator">+</span> <span class="quote">'/public'</span> ));
});

app.configure( <span class="quote">'development'</span>, <span class="reserved">function</span> () { app.use( express.errorHandler( { dumpExceptions: <span class="bool">true</span>, showStack: <span class="bool">true</span> } ) ); });
app.configure( <span class="quote">'production'</span>,  <span class="reserved">function</span> () { app.use( express.errorHandler() ); } );

<span class="comment">// #############################################################################################################</span>

<span class="comment">// fake database</span>
<span class="reserved">var</span> users <span class="operator">=</span> [
    { id: <span class="number">1</span>, username: <span class="quote">'John'</span>, password: <span class="quote">'pass'</span>,     domain: <span class="quote">"http://localhost:2563/"</span>, email: <span class="quote">'john@example.com'</span> }
  , { id: <span class="number">2</span>, username: <span class="quote">'joe'</span>,  password: <span class="quote">'birthday'</span>, domain: <span class="quote">"www.domain.com"</span>,         email: <span class="quote">'joe@example.com'</span> }
];

<span class="comment">// #############################################################################################################</span>

<span class="reserved">function</span> <span class="funcName">findByUsername</span>( username, fn )
{
    <span class="operator">for</span> (<span class="reserved">var</span> i <span class="operator">=</span> <span class="number">0</span>, len <span class="operator">=</span> users.<span class="methodName">length</span>; i <span class="operator">&lt;</span> len; i<span class="operator">++</span>)
    {
        <span class="reserved">var</span> user <span class="operator">=</span> users[i];
        <span class="operator">if</span> (user.username <span class="operator">===</span> username) <span class="operator">return</span> fn( <span class="bool">null</span>, user );
    }
    <span class="operator">return</span> fn(<span class="bool">null</span>, <span class="bool">null</span>);
}

<span class="comment">// -------------</span>
<span class="comment">// Passport conf</span>
<span class="comment">// -------------</span>

<span class="comment">// Use the DigestStrategy within Passport.</span>
<span class="comment">// This strategy requires a `secret`function, which is used to look up the</span>
<span class="comment">// use and the user's password known to both the client and server. The</span>
<span class="comment">// password is used to compute a hash, and authentication will fail if the</span>
<span class="comment">// computed value does not match that of the request. Also required is a</span>
<span class="comment">// `validate` function, which can be used to validate nonces and other</span>
<span class="comment">// authentication parameters contained in the request.</span>
passport.use
(
  <span class="operator">new</span> <span>DigestStrategy</span>(
    { qop: <span class="quote">'auth'</span>, realm: <span class="quote">'your.realm'</span> },
    <span class="reserved">function</span>( username, done )
    {
        <span class="comment">// Find the user by username. If there is no user with the given username</span>
        <span class="comment">// set the user to `false` to indicate failure. Otherwise, return the</span>
        <span class="comment">// user and user's password.</span>
        findByUsername(
            username, 
            <span class="reserved">function</span>( err, user )
            {
                <span class="operator">if</span> ( err )   <span class="operator">return</span> done( err );
                <span class="operator">if</span> ( <span class="operator">!</span>user ) <span class="operator">return</span> done( <span class="bool">null</span>, <span class="bool">false</span> );
                <span class="operator">return</span> done( <span class="bool">null</span>, user, user.password );
            }
        );
    },
    <span class="reserved">function</span>( params, done ) <span class="comment">// second callback</span>
    {
        <span class="comment">// asynchronous validation, for effect...</span>
        process.nextTick(
            <span class="reserved">function</span> ()
            {
                <span class="comment">// check nonces in params here, if desired</span>
                <span>console</span><span class="methodName">.log</span>( params );
                <span class="comment">/*
                nonce: 'MYto1vSuu6eK9PMNNYAqIdsmUXOA2ppU',
                cnonce: 'MDA4NjY5',
                nc: '00000001',
                opaque: undefined }
                */</span>
                <span class="operator">return</span> done( <span class="bool">null</span>, <span class="bool">true</span> );
            }
        );
    }
));

<span class="comment">// #################################################################################</span>

app.<span class="methodName">all</span>(
    <span class="quote">'/'</span>,
    <span class="comment">// Authenticate using HTTP Digest credentials, with session support disabled.</span>
    passport.authenticate( <span class="quote">'digest'</span>, { session: <span class="bool">false</span> } ),
    <span class="reserved">function</span>( req, res )
    {
        <span class="comment">/************************************************/</span>
        <span class="comment">//  CROSS-DOMAIN RESOURCE SHARING</span>
        res.setHeader( <span class="quote">'Access-Control-Allow-Origin'</span>, <span class="quote">'*'</span> );
        <span class="comment">/************************************************/</span>

        <span class="comment">// domain check</span>
        <span class="operator">if</span> ( req.user.<span class="methodName">domain</span>.<span class="methodName">match</span>( req.<span class="methodName">headers</span>.origin ) )
          res.json( { logged: <span class="bool">true</span>, username: req.user.username, email: req.user.email } );
    }
);

app.listen( <span class="number">3000</span> );
</pre>
<p></p>
<p>In digest.js you can specify your authentication realm.</p>
<p><span class="quote">'digest.js'&nbsp; (line 74; node_modules/passport-http/lib/passport-http/strategies)<br /></span></p>
<pre>this.<span class="private">_realm</span> = options.realm<span class="operator"> |</span><span class="operator">| </span><span class="quote">'your.realm'</span>;</pre>
<p></p>
<p>Authenticate.js (node_modules/passport/lib/passport/middleware; line 150).</p>
<p><a href="http://stackoverflow.com/a/15734032" title="Stackoverflow"><em>The W3 spec for CORS preflight requests clearly states that user credentials should be excluded. There is a bug in Chrome and WebKit where <code>OPTIONS</code> requests returning a status of 401 still send the subsequent request. </em></a></p>
<p><a href="http://stackoverflow.com/a/15734032" title="Stackoverflow"><em>Firefox has a related bug filed that ends with a link to the W3 public webapps mailing list asking for the CORS spec to be changed to allow authentication headers to be sent on the <code>OPTIONS</code> request at the benefit of IIS users. Basically, they are waiting for those servers to be obsoleted.</em></a></p>
<p><a href="http://stackoverflow.com/a/15734032" title="Stackoverflow"><em><strong>How can I get the <code>OPTIONS</code> request to send and respond consistently?</strong></em></a></p>
<p><a href="http://stackoverflow.com/a/15734032" title="Stackoverflow"><em>Simply have the server (API in this example) respond to <code>OPTIONS</code> requests without requiring authentication.</em> </a></p>
<p>In order to allow CORS requests ant to be able to read the info that the server sends, we need to expose the <em><span class="quote">WWW-Authenticate </span></em>header and the <em>GET</em> and <em>OPTIONS</em> methods.</p>
<p><br />A special situation happens. Safari for windows does not read theWWW-Authenticate header though exposed. So we have to expose another one.</p>
<p><span class="quote">'Authenticate.js'</span></p>
<pre>      res<span class="operator">.</span>statusCode <span class="operator">=</span> rstatus <span class="operator">||</span> <span class="number">401</span>;
      <span class="operator">if</span> ( req<span class="operator">.</span>method <span class="operator">===</span> <span class="quote">"OPTIONS"</span> ) res<span class="operator">.</span>statusCode <span class="operator">=</span> rstatus <span class="operator">||</span> <span class="number">200</span>;
      
      <span class="operator">if</span> (rchallenge<span class="operator">.</span>length)
      {
        res<span class="operator">.</span>setHeader(<span class="quote">'WWW-Authenticate'</span>, rchallenge);
        res<span class="operator">.</span>setHeader(<span class="quote">'Content-Type'</span>, rchallenge);
        
        <span class="multiComment">/**********************************/</span>
        <span class="multiComment">/* MODIFIED TO FULFIL DIGEST AUTH */</span>
        <span class="multiComment">/**********************************/</span>
        res<span class="operator">.</span>setHeader(<span class="quote">'Access-Control-Expose-Headers'</span>, <span class="quote">'WWW-Authenticate, Content-Type'</span>);
        
        res<span class="operator">.</span>setHeader(<span class="quote">"Access-Control-Allow-Headers"</span>, <span class="quote">"Authorization, Content-Type"</span>);
        res<span class="operator">.</span>setHeader(<span class="quote">"Access-Control-Allow-Methods"</span>, <span class="quote">"GET, OPTIONS"</span>);
        res<span class="operator">.</span>setHeader(<span class="quote">'Access-Control-Allow-Origin'</span>, <span class="quote">'*'</span>);
        
        <span class="multiComment">/**********************************/</span>
      }
      res<span class="operator">.</span>end(<span class="quote">'Unauthorized'</span>);
</pre>
<p></p>
<p></p>
